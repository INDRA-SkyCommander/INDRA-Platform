import subprocess
import os
import time
import GUI
import indra_util


def run_exploit(gui_selected_module):
        """Will write current state of software and selected target to module_input_data.json file.
        After writing, will run the selected module with the parameters set in module_input_data.json.

        Args:
            gui_selected_module (String): The string representing the module that is currently selected on the Graphical User Interface
        """

        if GUI.MainGUI.isScanning:
                print('Stop scanning before launching a module!')
                return

        if gui_selected_module == 'Modules':
                print('Please select a module before hitting \"exploit\"!')
                return


        print(f"Running Module: {gui_selected_module}")
        
        # Capture Path to module_input_data.json file
        module_input_file_path = os.path.dirname(__file__) + "/../modules/module_input_data.json"
        
        with open(module_input_file_path, "w") as f:
                # Capture current target's name and info
                target_name = indra_util.get_target()
                target_info = indra_util.get_info()
                options_info = GUI.MainGUI.get_module_options()
                # Write contents of indra_util.current_target to modules/module_input_data.json
                f.write(target_name)
                # Write contents of indra_util.target_info_list to modules/module_input_data.json
                for item in target_info:
                        f.write(str(item).strip())
                        f.write("\n")
                f.write("\n")
                # Write contents of GUI.MainGUI.options_list to modules/module_input_data.json
                for item in options_info:
                        f.write(str(item).strip())
                        f.write("\n")

        module_return_code = subprocess.call(['/usr/bin/python3.11', f'modules/{gui_selected_module}.py'])
